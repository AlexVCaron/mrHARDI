BootStrap: library
From: avcaron/default/magic_monkey_heavy:v1.0

%environment
        export PYTHON_27_BIN=/mms/dev/python2.7/bin
        export PYTHON_37_BIN=/mms/dev/python3.7/bin
        export FSL_BIN=/mms/dev/fsl/bin
        export MRTRIX_BIN=/mms/dev/mrtrix/bin
        export DIAMOND_BIN=/mms/dev/diamond/bin
        export ANTS_BIN=/mms/dev/ants/bin

        export PATH=$ANTS_BIN:$DIAMOND_BIN:$MRTRIX_BIN:$FSL_BIN:$PYTHON_37_BIN:$PYTHON_27_BIN:$PATH

        export CUDA_HOME=/usr/local/cuda-9.1
        export LD_LIBRARY_PATH=${CUDA_HOME}/lib64
%setup
        SOURCES=$SINGULARITY_ROOTFS/mms/sources
        MMY_sources=$SOURCES/magic_monkey
        cwd=$PWD

        mkdir -p $MMY_sources
        mkdir -p /tmp/tempwheel
        cd ..

        pip3 install --upgrade setuptools wheel
        python3 setup.py bdist_wheel -b /tmp/tempwheel -d $MMY_sources
        cp requirements.txt $MMY_sources/.

        cd $cwd
        cp utils.sh $SOURCES/mmy_utils.sh
%post
        . ./mms/sources/mmy_utils.sh

        # PATHS VARIABLES FOR SOURCES
        SOURCES=/mms/sources
        MMY_sources=$SOURCES/magic_monkey

        remove_if_exists $SCILPY_sources

        # PATHS VARIABLES FOR INSTALLATION
        INSTALL=/mms/dev
        PYTHON_27=$INSTALL/python2.7
        PYTHON_37=$INSTALL/python3.7
        SCILPY=$INSTALL/scilpy

        mkdir -p $INSTALL

        # SET ENVIRONMENT VARIABLES FOR LATER
        export PATH=$PYTHON_27/bin:$PYTHON_37/bin:$PATH

        last_mmy_ver_installed () {
            cwd=$PWD
            mmy_pip_descr="$(echo "$(pip3.7 list | grep magic-monkey)" || echo "NONE")"
            curr_ver="NONE"

            if [ "$mmy_pip_descr" != "NONE" ]
            then
                curr_ver="$(echo "$mmy_pip_descr" | cut -d' ' -f8)"
            fi

            cd $MMY_sources
            mmy_wheel="$(basename "$(ls | grep *.whl)")"
            cd $cwd

            [ "$curr_ver" == "$(get_version $mmy_wheel)" ]
        }

        # CHECK CURRENT COMPLETED INSTALLATION STATE
        scilpy_installed=$(assert_installation_complete $INSTALL scilpy)
        mmy_installed=$(assert_installation_complete $INSTALL magic_monkey)

        if [ ! $scilpy_installed ] || [ ! $mmy_installed ]
        then
            sed -i 's/main/main restricted universe/g' /etc/apt/sources.list
            apt-get update && apt-get -y upgrade
            apt-get -y install build-essential
            apt-get -y install gfortran
            apt-get -y install git
            apt-get -y install libblas-dev
            apt-get -y install liblapack-dev

            if [ ! $mmy_installed ] || [ ! last_mmy_ver_installed ]
            then
                mmy_installer () {
                    cd $MMY_sources
                    pip3.7 install -r requirements.txt
                    pip3.7 install magic_monkey-*-py3-none-any.whl
                }

                ERR_VAR=$(mmy_installer) && touch $INSTALL/magic_monkey_complete.flag || error_exit
            fi

            if [ ! $scilpy_installed ]
            then
                scilpy_installer () {
                    mkdir -p $SCILPY
                    git clone https://github.com/scilus/scilpy.git $SCILPY

                    cd $SCILPY
                    pip3.7 install -e .
                }

                ERR_VAR=$(scilpy_installer) && touch $INSTALL/scilpy_complete.flag || error_exit
            fi

            update-alternatives --install /usr/bin/python3 python3 /mms/dev/python3.7/bin/python3.7 1
            update-alternatives --config python3
            update-alternatives --set python3 /mms/dev/python3.7/bin/python3.7
            ln -s /usr/share/pyshared/lsb_release.py /mms/dev/python3.7/lib/python3.7/site-packages/lsb_release.py

            apt-get -y remove build-essential
            apt-get -y remove gfortran
            apt-get -y remove git
            apt-get -y remove g++
            apt-get -y remove g++-5
            apt-get -y remove gfortran-5
            apt-get -y remove git-man

            exit 0
        fi
