services:
  build-image:
    build:
      context: ./builders
      dockerfile: ../base.dockerfile
      target: build-image
      cache_to:
        - type=local,dest=./.cache/build_image
  light-image:
    build:
      context: ./builders
      dockerfile: ../base.dockerfile
      target: light-image
      cache_to:
        - type=local,dest=./.cache/light_image
  deploy-nogpu:
    build:
      context: ./deploy
      dockerfile: ../base.dockerfile
      target: deploy-nogpu
      cache_to:
        - type=local,dest=./.cache/deploy_nogpu
  deploy-gpu:
    build:
      context: ./deploy
      dockerfile: ../base.dockerfile
      target: deploy-gpu
      cache_from:
        - type=local,src=./.cache/deploy_nogpu
      cache_to:
        - type=local,dest=./.cache/deploy_gpu
  file-getter:
    build:
      context: ./builders
      dockerfile: ../builders.dockerfile
      target: file-getter
      cache_from:
        - type=local,src=./.cache/light_image
      cache_to:
        - type=local,dest=./.cache/file_getter
  cmake-builder:
    build:
      context: ./builders
      dockerfile: ../builders.dockerfile
      target: cmake-builder
      cache_from:
        - type=local,dsrc=./.cache/file_getter
      cache_to:
        - type=local,dest=./.cache/cmake_builder
  nvidia-builder:
    build:
      context: ./builders
      dockerfile: ../builders.dockerfile
      target: nvidia-builder
      cache_from:
        - type=local,dsrc=./.cache/build_image
      cache_to:
        - type=local,dest=./.cache/nvidia_builder
